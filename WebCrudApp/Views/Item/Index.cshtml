@model Library.Models.Item.ItemPageViewModel

<h2>Malzeme işlemleri</h2>

<form method="post" id="itemForm" action="javascript:void(0)">
    <input type="hidden" name="logicalRef" id="logicalRef" />

    <div class="form-group">
        <label>CODE:</label>
        <input type="text" class="form-control" id="code" name="CODE" value="@ViewBag.Code" placeholder="000" />
        <small id="codeHelp" class="form-text text-muted">Code must be unique, please check the list.</small>
    </div>

    <div class="form-group">
        <label>NAME:</label>
        <input type="text" class="form-control" id="name" name="NAME" placeholder="Name of the Item" value="@ViewBag.Name" />
        <small id="nameHelp" class="form-text text-muted">Please enter the Name of Item.</small>
    </div>

    <div class="form-group">
        <label>UNIT SET:</label>
        @Html.DropDownListFor(
        m => m.Item.UNITSETREF,
                Model.UnitSets,
                "-- Seçiniz --",
                new { id = "UNITSETREF", @class = "form-control" }
                )
    </div>
</form>

<div class="alert alert-warning" role="alert">
    <strong>Lütfen yapacağınız işlemi seçin:</strong>
</div>

<button id="btnLoad" type="button" class="btn btn-primary">Listele</button>
<button id="btnCreate" type="button" class="btn btn-outline-success">Ekle</button>
<button id="btnSearch" type="button" class="btn btn-secondary">Bul</button>
<button id="btnUpdate" type="button" class="btn btn-outline-warning">Güncelle</button>
<button id="btnDelete" type="button" class="btn btn-outline-danger">Sil</button>

<hr />

<!-- Liste div container -->
<div id="itemListContainer"></div>

<script src="~/lib/jquery/dist/jquery.min.js"></script>
<script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>

<script>
    $(document).ready(function () {
        $("#btnLoad").click();

        $("#itemForm").on("submit", function(e){
            e.preventDefault();
        });
    });

    // Row select
    $(document).on("click", ".rowSelect", function () {
        $(".rowSelect").removeClass("table-active");
        $(this).addClass("table-active");

        $("#logicalRef").val($(this).data("id"));
        $("#code").val($(this).data("code"));
        $("#name").val($(this).data("name"));
        $("#UNITSETREF").val($(this).data("unitsetref"));
    });

    // Listele
    $("#btnLoad").click(function () {
        $.get("/Item/GetItemsPartial", function (html) {
            $("#itemListContainer").html(html);
        });
    });

    // Bul
    $("#btnSearch").click(function () {
        $.get("/Item/SearchPartial", {
            code: $("#code").val(),
            name: $("#name").val(),
            unitSetRef: $("#UNITSETREF").val()
        }, function (html) {
            $("#itemListContainer").html(html);
        });
    });

    // Create
    $("#btnCreate").on("click", function () {
        $.ajax({
            url: '/Item/Create',
            type: 'POST',
            data: {
                CODE: $("#code").val(),
                NAME: $("#name").val(),
                UNITSETREF: $("#UNITSETREF").val()
            },
            success: function () {
                alert("Eklendi");
                $("#btnLoad").click();
            },
            error: function (err) {
                console.log(err);
                alert("Create hatası");
            }
        });
    });

    // Update
    $("#btnUpdate").click(function () {
        const id = $("#logicalRef").val();
        if (!id) { alert("Lütfen güncellenecek kaydı seçin"); return; }

        const unitSetRef = $("#UNITSETREF").val();
        if (!unitSetRef) { alert("Lütfen bir birim set seçin"); return; }

        $.post("/Item/Update", {
            LOGICALREF: id,
            CODE: $("#code").val(),
            NAME: $("#name").val(),
            UNITSETREF: unitSetRef
        })
        .done(function () {
            alert("Güncellendi");
            $("#btnLoad").click();
        })
        .fail(function (xhr) {
            alert("Update başarısız: " + xhr.responseText);
        });
    });

    // Delete
    $("#btnDelete").click(function () {
        const id = $("#logicalRef").val();
        if (!id) { alert("Lütfen silinecek kaydı seçin"); return; }
        if (!confirm("Bu kaydı silmek istediğinize emin misiniz?")) return;

        $.post("/Item/Delete", { id: id })
            .done(function () {
                alert("Silindi");
                $("#btnLoad").click();
                $("#logicalRef").val('');
                $("#code").val('');
                $("#name").val('');
                $("#UNITSETREF").val('');
            })
            .fail(function () {
                alert("Silme başarısız");
            });
    });
</script>
