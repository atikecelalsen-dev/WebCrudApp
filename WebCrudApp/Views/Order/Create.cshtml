@model Library.Models.Order.OrderCreateViewModel
@{
    bool isEdit = Model.Header.LOGICALREF > 0;
    ViewBag.Title = (isEdit ? "Sipariş Düzenle" : "Yeni Sipariş");
}

<h3 class="mb-4 text-xl font-semibold text-slate-800">
    @(isEdit ? "Sipariş Düzenle" : "Yeni Sipariş")
</h3>

<form method="post"
      id="itemForm"
      action="@(isEdit ? "/Order/Edit" : "/Order/Create")"
      class="space-y-6">

    @Html.AntiForgeryToken()

    <!-- HEADER -->
    <div class="rounded-lg border border-black bg-gray-50 p-5 shadow-md">
        <input type="hidden" name="Header.LOGICALREF" value="@Model.Header.LOGICALREF" />

        <div class="grid gap-4 md:grid-cols-2">
            <div class="space-y-3">
                <div>
                    <label class="block text-sm font-medium">Sipariş Tipi</label>
                    @Html.DropDownListFor(
                        m => m.Header.TRCODE,
                        Model.OrderTypes,
                        "-- Seçiniz --",
                        new { @class = "w-full rounded border px-3 py-2 bg-white", id = "orderTypeSelect" })
                </div>

                <div>
                    <label class="block text-sm font-medium">Tarih</label>
                    <input type="date"
                           name="Header.DATE_"
                           id="DATE_"
                           value="@(Model.Header.DATE_.ToString("yyyy-MM-dd"))"
                           class="w-full rounded border bg-white px-3 py-2" />
                </div>

                <input type="hidden" name="Header.TIME_" id="TIME_" />
            </div>

            <div class="space-y-3">
                <div>
                    <label class="block text-sm font-medium">Sipariş Numarası</label>
                    <input type="text"
                           name="Header.FICHENO"
                           value="@Model.Header.FICHENO"
                           class="w-full rounded border bg-white px-3 py-2"
                           placeholder="00000000001" />
                </div>

                <div>
                    <label class="block text-sm font-medium">Müşteri</label>
                    @Html.DropDownListFor(
                        m => m.Header.CLIENTREF,
                        Model.Clients,
                        "-- Seçiniz --",
                        new { @class = "w-full rounded border px-3 py-2 bg-white" })
                </div>
            </div>
        </div>
    </div>






    <!-- LINE ITEMS -->
    <div class="rounded-lg border border-black bg-gray-50 p-5 shadow-md">
        <div id="lineItemsBody" class="space-y-3">

            @for (int i = 0; i < (Model.Lines?.Count ?? 1); i++)
            {
                var line = Model.Lines != null && Model.Lines.Any()
                    ? Model.Lines[i]
                    : new Library.Models.Order.OrderLineModel();

                <div class="line-row rounded border bg-gray-50 p-3 shadow-sm"
                     data-index="@i">

                    <div class="grid gap-3 md:grid-cols-12">

                        <div class="md:col-span-3">
                            <label class="text-sm font-medium">Malzeme</label>
                            <select name="Lines[@i].STOCKREF"
                                    class="productSelect w-full rounded border px-2 py-1"
                                    data-selected="@line.STOCKREF">
                            </select>
                        </div>

                        <div class="md:col-span-1">
                            <label class="text-sm font-medium">Miktar</label>
                            <input type="number"
                                   name="Lines[@i].AMOUNT"
                                   value="@line.AMOUNT"
                                   class="w-full rounded border px-2 py-1" />
                        </div>

                        <div class="md:col-span-2">
                            <label class="text-sm font-medium">Birim</label>
                            <select class="unitSelect w-full rounded border px-2 py-1"
                                    data-uom="@line.UOMREF"
                                    data-us="@line.USREF">
                                <option value="">-- Seçiniz --</option>
                            </select>

                            <input type="hidden" name="Lines[@i].UOMREF" value="@line.UOMREF" />
                            <input type="hidden" name="Lines[@i].USREF" value="@line.USREF" />
                        </div>

                        <div class="md:col-span-2">
                            <label class="text-sm font-medium">Fiyat</label>
                            <input type="number"
                                   name="Lines[@i].PRICE"
                                   value="@line.PRICE"
                                   class="w-full rounded border px-2 py-1" />
                        </div>

                        <div class="md:col-span-1">
                            <label class="text-sm font-medium">KDV %</label>
                            <input type="number"
                                   name="Lines[@i].VAT"
                                   value="@(line.VAT == 0 ? 20 : line.VAT)"
                                   class="w-full rounded border px-2 py-1" />
                        </div>

                        <div class="md:col-span-1">
                            <label class="text-sm font-medium">KDV</label>
                            <input type="number"
                                   name="Lines[@i].VATAMNT"
                                   class="w-full rounded border bg-gray-100 px-2 py-1"
                                   readonly />
                        </div>

                        <div class="md:col-span-1">
                            <label class="text-sm font-medium">Tutar</label>
                            <input type="number"
                                   name="Lines[@i].LINENET"
                                   class="w-full rounded border bg-gray-100 px-2 py-1"
                                   readonly />
                        </div>

                        <div class="flex items-end md:col-span-1">
                            <button type="button"
                                    class="removeLine w-full rounded bg-red-500 px-2 py-1 text-white hover:bg-red-600">
                                Sil
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- ACTIONS -->
    <div class="flex items-center justify-between">
        <button type="button"
                id="addLineItem"
                class="rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700">
            Yeni Satır Ekle
        </button>

        <div class="flex w-1/3 items-center gap-2 sm:w-2/3 md:w-1/2">
            <label class="w-1/4 font-semibold">İNDİRİM</label>
            <input type="number"
                   id="discountValue"
                   class="w-2/4 rounded border px-2 py-1"
                   value="0" />
            <select id="discountType"
                    class="w-1/4 rounded border px-2 py-1">
                <option value="percent">%</option>
                <option value="amount">Tutar</option>
            </select>
        </div>
    </div>
     
    <!-- ALT TOPLAM & İNDİRİM -->
<div class="flex justify-end">
    <div class="w-1/3 overflow-hidden rounded-lg border border-black
            bg-gray-50 shadow-md sm:w-2/3 md:w-1/2">

        <!-- TOPLAM TUTAR -->
        <div class="m-3 flex items-center">
            <div class="w-1/2 px-2">
                <label class="text-md font-semibold">TOPLAM TUTAR</label>
            </div>
            <div class="w-1/2 px-2">
                <input type="text"
                       id="GrossTotal"
                       name="Header.GROSSTOTAL"
                       readonly
                       value="0"
                       class="w-full rounded border bg-white px-2 py-1 text-right" />
            </div>
        </div>

        <!-- TOPLAM KDV -->
        <div class="m-3 flex items-center">
            <div class="w-1/2 px-2">
                <label class="text-md font-semibold">TOPLAM KDV</label>
            </div>
            <div class="w-1/2 px-2">
                <input type="text"
                       id="TotalVAT"
                       name="Header.TOTALVAT"
                       readonly
                       value="0"
                       class="w-full rounded border bg-white px-2 py-1 text-right" />
            </div>
        </div>

        <!-- TOPLAM İNDİRİM -->
        <div class="m-3 flex items-center">
            <div class="w-1/2 px-2">
                <label class="text-md font-semibold">TOPLAM İNDİRİM</label>
            </div>
            <div class="w-1/2 px-2">
                <input type="text"
                       id="discount"
                       readonly
                       value="0"
                       class="w-full rounded border bg-white px-2 py-1 text-right" />
            </div>
        </div>

        <!-- NET TUTAR -->
        <div class="m-3 flex items-center">
            <div class="w-1/2 px-2">
                <label class="text-md font-semibold">NET TUTAR</label>
            </div>
            <div class="w-1/2 px-2">
                <input type="text"
                       id="NetTotal"
                       name="Header.NETTOTAL"
                       readonly
                       value="0"
                       class="w-full rounded border bg-white px-2 py-1 text-right" />
            </div>
        </div>

        <!-- HIDDEN INPUTLAR -->
        <input type="hidden"
               id="ADDDISCOUNTS"
               name="Header.ADDDISCOUNTS"
               value="@Model.Header.ADDDISCOUNTS" />

        <input type="hidden"
               id="TOTALDISCOUNTS"
               name="Header.TOTALDISCOUNTS"
               value="@Model.Header.TOTALDISCOUNTS" />

        <input type="hidden"
               id="TOTALDISCOUNTED"
               name="Header.TOTALDISCOUNTED"
               value="@Model.Header.TOTALDISCOUNTED" />

        <input type="hidden"
               id="ReportNet"
               name="Header.REPORTNET"
               value="@Model.Header.REPORTNET" />
    </div>
</div>
    <!-- SUBMIT -->
    <div class="flex justify-end">
        @if (isEdit)
        {
            <button type="button"
                    id="btnUpdate"
                    class="rounded bg-yellow-600 px-6 py-2 text-white hover:bg-yellow-700">
                Güncelle
            </button>
        }
        else
        {
            <button type="button"
                    id="btnSave"
                    class="rounded bg-green-600 px-6 py-2 text-white hover:bg-green-700">
                Kaydet
            </button>
        }
    </div>

</form>


<!-- ITEM MODAL -->
<div id="itemModal"
     class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 backdrop-blur-sm">
    <div class="relative w-1/3 overflow-hidden rounded-xl border
        border-black bg-white shadow-2xl sm:w-2/3 md:w-1/2">

        <!-- HEADER -->
        <div class="flex items-center justify-between border-b bg-slate-50 px-6 py-4">
            <h5 class="text-lg font-semibold text-slate-800">
                Malzeme ve Stoklar
            </h5>
            <button type="button"
                    onclick="closeItemModal()"
                    class="text-2xl font-bold text-gray-500 hover:text-gray-700">
                &times;
            </button>
        </div>

        <!-- BODY -->
        <div class="max-h-[70vh] overflow-auto bg-gray-100 p-4">
            <table class="w-full overflow-hidden rounded-lg border border-slate-200 text-sm"
                   id="itemModalTable">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="border-b px-3 py-2 text-left">Kodu</th>
                        <th class="border-b px-3 py-2 text-left">Ürün Adı</th>
                        <th class="border-b px-3 py-2 text-right">Stok</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                    @foreach (var item in Model.Items)
                    {
                        <tr class="selectable-item cursor-pointer bg-white hover:bg-blue-50"
                            data-ref="@item.Value"
                            data-name="@item.Text">
                            <td class="px-3 py-2 font-medium text-slate-800">
                                @item.Code
                            </td>

                            <td class="px-3 py-2 text-slate-700">
                                @item.Text
                            </td>

                            <td class="px-3 py-2 text-right font-semibold text-slate-800">
                                @item.OnHand
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

    </div>
</div>

<script>
    let lineIndex = $(".line-row").length;
    const productUnits = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.ProductUnits));

    $(document).ready(function () {
        const dbDiscount = parseFloat($("#TOTALDISCOUNTS").val()) || 0;
        recalcTotals();
        const gross = parseFloat($("#GrossTotal").val()) || 0;
            console.log(gross + "ve "+ dbDiscount)
        const percent = (dbDiscount / gross) * 100;
        if (dbDiscount > 0 && Number.isInteger(percent)) {
            $("#discountValue").val(percent);
            $("#discountType").val("percent");
                
        } else {
            $("#discountValue").val(dbDiscount);
            $("#discountType").val("amount");
        }


      $(".productSelect").each(function () {
              const select = $(this);
              const stockRef = select.data("selected");

              if (!stockRef) return;
             
                  const itemRow = $("#itemModalTable tr").filter(function () {
                     return String($(this).data("ref")) === String(stockRef); });
                const itemName = itemRow.data("name");


              select
                  .empty()
                  .append(`<option value="${stockRef}" selected>${itemName}</option>`);
              
                  fillUnits(this);

              const row = select.closest(".line-row");
              const unitSelect = row.find(".unitSelect");

              const uom = unitSelect.data("uom");
              const us = unitSelect.data("us");

                   setTimeout(() => {
                        if (uom && us) {
                            unitSelect.val(`${uom}|${us}`).trigger("change");
                        }
                    }, 0);
          });

          recalcTotals();
      });

      function reindexOrderLines() {
            $('#lineItemsBody .line-row').each(function (index) {

            // data-index güncelle
            $(this).attr('data-index', index);

            // input & select name'lerini güncelle
            $(this).find('input, select').each(function () {
                var name = $(this).attr('name');
                if (!name) return;

                var newName = name.replace(/Lines\[\d+\]/, 'Lines[' + index + ']');
                $(this).attr('name', newName);
            });
        });
    }


    function fillUnits(productSelect) {
        const row = $(productSelect).closest(".line-row");
        const unitSelect = row.find(".unitSelect");
        const productId = parseInt($(productSelect).val(), 10);

        unitSelect.empty().append('<option value="">-- Seçiniz --</option>');

        if (productUnits && productUnits[productId]) {
            productUnits[productId].forEach(u => {
                unitSelect.append(`<option value="${u.Value}">${u.Text}</option>`);
            });
        }
    }

    function updateLinePrice(row) {

        const itemRef = row.find(".productSelect").val();
        const uomRef = row.find("input[name$='.UOMREF']").val();
        const orderType = $("#orderTypeSelect").val();

        if (!itemRef || !uomRef || !orderType) return;

        $.get("/Order/GetPrice", {
            itemRef: itemRef,
            uomRef: uomRef,
            orderType: orderType
        }, function (price) {
            row.find("input[name$='.PRICE']").val(price);
            recalcTotals();
        });
    }

    $("#orderTypeSelect").on("change", function () {

        let hasAnyProduct = false;

        $("#lineItemsBody .line-row").each(function () {
            const itemRef = $(this).find(".productSelect").val();
            if (itemRef) hasAnyProduct = true;
        });

        if (!hasAnyProduct) return;

        alert("Sipariş türü değiştirildi. Birim fiyatlar güncellenecektir.");

        $("#lineItemsBody .line-row").each(function () {
            updateLinePrice($(this));
        });
    });

        $("#lineItemsBody").on("change", ".unitSelect", function () {

        const row = $(this).closest(".line-row");
        const [uomRef, usRef] = $(this).val().split("|");

        row.find("input[name$='.UOMREF']").val(uomRef);
        row.find("input[name$='.USREF']").val(usRef);

        updateLinePrice(row);
    });


function openItemModal() {
    $("#itemModal").removeClass("hidden").addClass("flex");
}

function closeItemModal() {
    $("#itemModal").addClass("hidden").removeClass("flex");
}


$("#addLineItem").click(function () {

    const row = `
    <div class="line-row mb-3 rounded border p-3" data-index="${lineIndex}">
        <div class="grid gap-3 md:grid-cols-12">

            <div class="md:col-span-3">
                <label class="text-sm font-medium">Malzeme</label>
                <select name="Lines[${lineIndex}].STOCKREF"
                        class="productSelect w-full rounded border px-2 py-1">
                </select>
            </div>

            <div class="md:col-span-1">
                <label class="text-sm font-medium">Miktar</label>
                <input type="number"
                       name="Lines[${lineIndex}].AMOUNT"
                       class="w-full rounded border px-2 py-1" />
            </div>

            <div class="md:col-span-2">
                <label class="text-sm font-medium">Birim</label>
                <select class="unitSelect w-full rounded border px-2 py-1">
                    <option value="">-- Seçiniz --</option>
                </select>
                <input type="hidden" name="Lines[${lineIndex}].UOMREF" value="0" />
                <input type="hidden" name="Lines[${lineIndex}].USREF" value="0" />
            </div>

            <div class="md:col-span-2">
                <label class="text-sm font-medium">Fiyat</label>
                <input type="number"
                       name="Lines[${lineIndex}].PRICE"
                       class="w-full rounded border px-2 py-1" />
            </div>

            <div class="md:col-span-1">
                <label class="text-sm font-medium">KDV %</label>
                <input type="number"
                       name="Lines[${lineIndex}].VAT"
                       value="20"
                       class="w-full rounded border px-2 py-1" />
            </div>

            <div class="md:col-span-1">
                <label class="text-sm font-medium">KDV</label>
                <input type="number"
                       name="Lines[${lineIndex}].VATAMNT"
                       readonly
                       class="w-full rounded border bg-gray-100 px-2 py-1" />
            </div>

            <div class="md:col-span-1">
                <label class="text-sm font-medium">Tutar</label>
                <input type="number"
                       name="Lines[${lineIndex}].LINENET"
                       readonly
                       class="w-full rounded border bg-gray-100 px-2 py-1" />
            </div>

            <div class="flex items-end md:col-span-1">
                <button type="button"
                        class="removeLine w-full rounded bg-red-500 px-2 py-1 text-white hover:bg-red-600">
                    Sil
                </button>
            </div>

        </div>
    </div>`;

    $("#lineItemsBody").append(row);
    reindexOrderLines()
});




      @* // //Ürün seçmek için Modal açıyoruz. *@
        $(document).on('mousedown', '.productSelect', function (e) {
        e.preventDefault();
        window.currentDropdown = this;
        // $('#itemModal').modal('show');
        openItemModal();
    });

      $(document).on('click', '.selectable-item', function () {
          if (!window.currentDropdown) return;
          const ref = $(this).data('ref');
          const name = $(this).data('name');
          const select = window.currentDropdown;
          if (!$(select).is("select")) {
              console.error("currentDropdown select değil:", select);
              return;
          }
          $(select)
              .empty()
              .append(`<option value="${ref}" selected>${name}</option>`);
          fillUnits(select);
          closeItemModal();
      });


      @* // Satır sil *@
      $("#lineItemsBody").on("click", ".removeLine", function(){
          if(!confirm('Bu satırı silmek istediğinize emin misiniz?')) return;
          $(this).closest(".line-row").remove();
          reindexOrderLines()
      });

      @* //Ürün seçildiğinde birimleri doldur *@
      $(document).on("change", ".productSelect", function () {
          fillUnits(this);
      });

     function recalcTotals() {
        let gross = 0;
        let totalVAT = 0;

        $("#lineItemsBody .line-row").each(function () {
            let qty = parseFloat($(this).find("input[name$='.AMOUNT']").val()) || 0;
            let price = parseFloat($(this).find("input[name$='.PRICE']").val()) || 0;
            let vat = parseFloat($(this).find("input[name$='.VAT']").val()) || 0;

            let lineTotal = qty * price;
            let lineVAT = lineTotal * vat / 100;

            $(this).find("input[name$='.LINENET']").val(lineTotal.toFixed(2));
            $(this).find("input[name$='.VATAMNT']").val(lineVAT.toFixed(2));

            gross += lineTotal;
            totalVAT += lineVAT;
        });

          @* // 🔽 İNDİRİM *@
          let discountValue = parseFloat($("#discountValue").val()) || 0;
          let discountType = $("#discountType").val();

          let discountAmount = 0;
          if (discountType === "percent") {
              discountAmount = gross * discountValue / 100;
          } else {
              discountAmount = discountValue;
          }
          let totalDiscounted = gross - discountAmount;
          let net = totalDiscounted + totalVAT;

          $("#discount").val(discountAmount.toFixed(2));

          document.getElementById("GrossTotal").value = gross.toFixed(2);
          document.getElementById("TotalVAT").value = totalVAT.toFixed(2);
          document.getElementById("NetTotal").value = net.toFixed(2);
          document.getElementById("ADDDISCOUNTS").value = discountAmount .toFixed(2);
          document.getElementById("TOTALDISCOUNTS").value = discountAmount .toFixed(2);
          document.getElementById("TOTALDISCOUNTED").value = totalDiscounted .toFixed(2);
          document.getElementById("ReportNet").value = net.toFixed(2);

      }

      @* // Satır değiştiğinde veya indirim değiştiğinde yeniden hesapla *@
      $("#lineItemsBody").on("input", "input", recalcTotals);
      $("#discountValue").on("input", recalcTotals);
      $("#discountType").on("change", recalcTotals);
      
      @* // Birim seçildiğinde UOMREF & USREF ayır *@
      $("#lineItemsBody").on("change", ".unitSelect", function () {
          const row = $(this).closest(".line-row");
          const [uomRef, usRef] = $(this).val().split("|");
          row.find("input[name$='.UOMREF']").val(uomRef);
          row.find("input[name$='.USREF']").val(usRef);
      });



      $(document).on("click", "#btnSave", function (e) {
            e.preventDefault();
            e.stopPropagation();

            console.log("BTN SAVE CLICKED");

            try {
                recalcTotals();
                console.log("Totals recalculated");
            } catch (err) {
                console.error("recalcTotals HATA:", err);
                alert("recalcTotals patladı");
                return;
            }

            const data = $("#itemForm").serialize();
            console.log("FORM DATA:", data);

            $.ajax({
                url: "/Order/Create",
                type: "POST",
                data: data,
                headers: {
                    "RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val()
                },
                success: function (res) {
                    console.log("SUCCESS:", res);
                    alert("Kaydedildi");
                    window.location.href = "/Order/Index";
                },
                error: function (xhr) {
                    console.error("AJAX ERROR:", xhr.responseText);
                    alert("AJAX hata");
                }
            });
        });
    

      @* // Submit öncesi toplamları güncelle *@
     function submitOrder(url) {
          recalcTotals();

          const logicalRef = $("input[name='Header.LOGICALREF']").val();
          console.log("LOGICALREF =", logicalRef);

          let formData = $("#itemForm").serialize();
          console.log("FORM DATA =", formData);

          $.ajax({
              url: url,
              type: "POST",
              data: formData,
              headers: {
                  'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
              },
              success: function (res) {
                  console.log("RESPONSE =", res);
                  alert(res.message || "OK");
                  window.location.href = "/Order/Index";
              },
              error: function (err) {
                  console.error(err.responseText);
              }
          });
      }



      $("#btnUpdate").on("click", function (e) {
          e.preventDefault();
          submitOrder("/Order/Edit");
      });



      @* // TIME_ otomatik oluştur *@
      function getLogoTime(){
          const d = new Date();
          return d.getHours()*10000 + d.getMinutes()*100 + d.getSeconds();
      }
      $("#TIME_").val(getLogoTime());


    
</script>
