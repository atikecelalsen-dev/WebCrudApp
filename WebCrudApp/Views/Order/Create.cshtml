@model WebCrudApp.Models.OrderCreateViewModel

<h3>Sipariş İşlemleri</h3>

<form method="post" id="itemForm" action="/Order/Create">
    @Html.AntiForgeryToken()

    <!-- HEADER -->
    <div class="header-section mb-3">
        <input type="hidden" name="Header.LOGICALREF" id="logicalRef" />

        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label>Order Type:</label>
                    @Html.DropDownListFor(
                    m => m.Header.TRCODE,
                                        Model.OrderTypes,
                                        "-- Seçiniz --",
                                        new { @class = "form-control" })
                </div>
                <div class="form-group">
                    <label>Tarih:</label>
                    <input type="date" name="Header.DATE_" class="form-control" id="DATE_" value="@DateTime.Now.ToString("yyyy-MM-dd")" />
                </div>
                <input type="hidden" name="Header.TIME_" id="TIME_" />
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label>Sipariş Numarası:</label>
                    <input type="text" name="Header.FICHENO" class="form-control" value="@ViewBag.FICHENO" placeholder="00000000001" />
                </div>
                <div class="form-group">
                    <label>Müşteri:</label>
                    @Html.DropDownListFor(
                                        m => m.Header.CLIENTREF,
                                        Model.Clients,
                                        "-- Seçiniz --",
                                        new { @class = "form-control" })
                </div>
            </div>
        </div>
    </div>

    <!-- LINE ITEMS -->
    <div class="line-items-section mb-3">
        <div class="card">
            <table id="itemTable" class="table table-hover" border="1" style="border-collapse: collapse;">
                <thead>
                    <tr>
                        <th>Malzeme</th>
                        <th>Miktar</th>
                        <th>Birim</th>
                        <th>Birim Fiyatı</th>
                        <th>KDV Oranı</th>
                        <th>KDV Tutarı</th>
                        <th>Tutar</th>
                        <th>İşlem</th>
                    </tr>
                </thead>
                <tbody id="lineItemsBody">
                    <tr>
                        <td>
                            <select name="Lines[0].STOCKREF" class="form-control productSelect">
                                <option value="">-- Seçiniz --</option>
                                @foreach (var p in Model.Items)
                                {
                                    <option value="@p.Value">@p.Text</option>
                                }
                            </select>
                        </td>
                        <td><input type="number" name="Lines[0].AMOUNT" class="form-control" /></td>
                        <td>
                            <select class="form-control unitSelect">
                                <option value="">-- Seçiniz --</option>
                            </select>
                            <input type="hidden" name="Lines[0].UOMREF" value="0" />
                            <input type="hidden" name="Lines[0].USREF" value="0" />


                        </td>
                        <td><input type="number" name="Lines[0].PRICE" class="form-control" /></td>
                        <td><input type="number" name="Lines[0].VAT" class="form-control" /></td>
                        <td><input type="number" name="Lines[0].VATAMNT" class="form-control" readonly /></td>
                        <td><input type="number" name="Lines[0].LINENET" class="form-control" readonly /></td>
                        
                        
                        <td>
                            <button type="button" class="btn btn-danger removeLine">Sil</button>
                        </td>
                       
                    </tr>
                </tbody>
            </table>
        </div>
        <button type="button" class="btn btn-primary" id="addLineItem">Yeni Satır Ekle</button>

    </div>
    <div class="col-md-3">
        <label>İndirim Ekle</label>
        <div class="input-group">
            <input type="number" id="discountValue" class="form-control" value="0" min="0" />
            <select id="discountType" class="form-select">
                <option value="percent">%</option>
                <option value="amount">Tutar</option>
            </select>
        </div>
    </div>

    <!-- ALT TOPLAM & İNDİRİM -->
    <div class="card mb-3">
        <div class="card-body">
            <div class="col-md-3">
                <div class="row">
                    <label>Toplam Tutar</label>
                    <input type="text" id="GrossTotal" name="Header.GROSSTOTAL" class="form-control" readonly value="0" />
                </div>
                <div class="row">
                    <label>Toplam KDV</label>
                    <input type="text" id="TotalVAT" name="Header.TOTALVAT" class="form-control" readonly value="0" />
                </div>
               
                <div class="row">
                    <label>Toplam Indirim</label>
                    <input type="text" id="discount"  class="form-control" readonly value="0" />
                </div>

                <div class="row">
                    <label>Net Tutar</label>
                    <input type="text" id="NetTotal" name="Header.NETTOTAL" class="form-control" readonly value="0" />
                </div>
            </div>


            <input type="hidden" id="ADDDISCOUNTS" name="Header.ADDDISCOUNTS" />
            <input type="hidden" id="TOTALDISCOUNTS" name="Header.TOTALDISCOUNTS" />
            <input type="hidden" id="TOTALDISCOUNTED" name="Header.TOTALDISCOUNTED" />
            
            <input type="hidden" id="ReportNet" name="Header.REPORTNET"/>
        </div>
    </div>

    <button type="button" id="btnSave" class="btn btn-primary">Kaydet</button>
</form>
</<br />

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    let lineIndex = 1;
    const productUnits = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.ProductUnits));

    // Yeni satır ekleme
    $("#addLineItem").click(function(){
        const row = `<tr>
            <td>
                <select name="Lines[${lineIndex}].STOCKREF" class="form-control productSelect">
                    <option value="">-- Seçiniz --</option>
                    ${Object.entries(@Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Items)))
                        .map(i => `<option value="${i[1].Value}">${i[1].Text}</option>`).join("")}
                </select>
            </td>
            <td><input type="number" name="Lines[${lineIndex}].AMOUNT" class="form-control" /></td>
            <td>
                <select class="form-control unitSelect">
                    <option value="">-- Seçiniz --</option>

                </select>
                 <input type="hidden" name="Lines[${lineIndex}].UOMREF" value="0"/> 
                 <input type="hidden" name="Lines[${lineIndex}].USREF" value="0" />

            </td>
            <td><input type="number" name="Lines[${lineIndex}].PRICE" class="form-control" /></td>
            <td><input type="number" name="Lines[${lineIndex}].VAT" class="form-control" /></td>
            <td><input type="number" name="Lines[${lineIndex}].VATAMNT" class="form-control" readonly /></td>
            <td><input type="number" name="Lines[${lineIndex}].LINENET" class="form-control" readonly /></td>
            <td><button type="button" class="btn btn-danger removeLine">Sil</button></td>
          
                  
    
        </tr>`;
        $("#lineItemsBody").append(row);
        lineIndex++;
    });

    // Satır sil
    $("#lineItemsBody").on("click", ".removeLine", function(){
        $(this).closest("tr").remove();
    });

    // Ürün seçildiğinde birimleri doldur
    $("#lineItemsBody").on("change", ".productSelect", function(){
        const row = $(this).closest("tr");
        const unitSelect = row.find(".unitSelect");
        const productId = $(this).val();
        unitSelect.html('<option value="">-- Seçiniz --</option>');
        if(productUnits[productId]){
            productUnits[productId].forEach(u => {
                unitSelect.append(`<option value="${u.Value}">${u.Text}</option>`);
            });
        }
    });

           function recalcTotals() {

        let gross = 0;
        let totalVAT = 0;

        $("#lineItemsBody tr").each(function () {
            let qty = parseFloat($(this).find("input[name$='.AMOUNT']").val()) || 0;
            let price = parseFloat($(this).find("input[name$='.PRICE']").val()) || 0;
            let vat = parseFloat($(this).find("input[name$='.VAT']").val()) || 0;

            let lineTotal = qty * price;
            let lineVAT = lineTotal * vat / 100;

            $(this).find("input[name$='.LINENET']").val(lineTotal.toFixed(2));
            $(this).find("input[name$='.VATAMNT']").val(lineVAT.toFixed(2));

            gross += lineTotal;
            totalVAT += lineVAT;
        });

        // 🔽 İNDİRİM
        let discountValue = parseFloat($("#discountValue").val()) || 0;
        let discountType = $("#discountType").val();

        let discountAmount = 0;
        if (discountType === "percent") {
            discountAmount = gross * discountValue / 100;
        } else {
            discountAmount = discountValue;
        }


        let totalDiscounted = gross - discountAmount; // 🔥 ASIL KONU BU
        let net = totalDiscounted + totalVAT;
       
    $("#discount").val(discountAmount.toFixed(2));
    document.getElementById("GrossTotal").value = gross.toFixed(2);
    document.getElementById("TotalVAT").value = totalVAT.toFixed(2);
    document.getElementById("NetTotal").value = net.toFixed(2);
    document.getElementById("ADDDISCOUNTS").value = discountAmount .toFixed(2);
    document.getElementById("TOTALDISCOUNTS").value = discountAmount .toFixed(2);
    document.getElementById("TOTALDISCOUNTED").value = totalDiscounted .toFixed(2);
    document.getElementById("ReportNet").value = net.toFixed(2);
  
  
    }

    // Satır değiştiğinde veya indirim değiştiğinde yeniden hesapla
    $("#lineItemsBody").on("input", "input", recalcTotals);
    $("#discountValue").on("input", recalcTotals);
    $("#discountType").on("change", recalcTotals);
        // Birim seçildiğinde UOMREF & USREF ayır
        $("#lineItemsBody").on("change", ".unitSelect", function () {
        const row = $(this).closest("tr");
        const [uomRef, usRef] = $(this).val().split("|");
        row.find("input[name$='.UOMREF']").val(uomRef);
        row.find("input[name$='.USREF']").val(usRef);
        console.log($("input[name$='.UOMREF']").val());
        console.log($("input[name$='.USREF']").val());
        console.log($("#itemForm").serialize());
    });

    // Submit öncesi toplamları güncelle
        $("#btnSave").click(function(){
        recalcTotals(); // <--- mutlaka çağrılacak
        $.ajax({
            url: '/Order/Create',
            type: 'POST',
            data: $("#itemForm").serialize(),
            headers: {'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()},
            success: function(){ alert("Kaydedildi"); location.reload(); },
            error: function(err){ console.log(err.responseText); alert("Hata"); }
        });
    });

    // TIME_ otomatik oluştur
    function getLogoTime(){
        const d = new Date();
        return d.getHours()*10000 + d.getMinutes()*100 + d.getSeconds();
    }
    $("#TIME_").val(getLogoTime());
</script>
