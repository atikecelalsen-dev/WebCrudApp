@model WebCrudApp.Models.ItemViewModel
@{
}
<h3 style="margin-top:10px; margin-bottom:20px; ">Malzeme Verilerini Düzenleyin : </h3>

<!-- ÜRÜN ÜST BİLGİ -->
<div class="card mb-3">
    <div class="card-header">
        <strong>Ürün Bilgileri</strong>
    </div>
    <div class="card-body">
        <div class="row mb-2">
            <div class="col-md-1"><strong>Kod: </strong></div>
            <div class="col-md-3">@Model.CODE</div>

            <div class="col-md-1"><strong>Ad: </strong></div>
            <div class="col-md-3">@Model.NAME</div>

            <div class="col-md-1"><strong>UnitName: </strong></div>
            <div class="col-md-3">@Model.UNITNAME</div>
        </div>
    </div>
</div>

<div class="card mb-3">
    <table id="itemTable" class="table table-hover" border="1" style="border-collapse: collapse;">
        <thead>
            <tr>
                <th>ITEM NAME</th>
                <th>LOGICALREF</th>
                <th>ITEMREF</th> 
                <th>UNITLINEREF</th>
                <th>UNITNAME</th>
                <th>BARCODE</th>
                <th>PURCHASEPRICE</th>
                <th>SALEPRICE</th>
                <th>   </th>
            </tr>
        </thead>
        <tbody id="itemBody">
            @foreach (var detail in Model.UnitDetails)
            {
                <tr data-itemref="@detail.ITEMREF"
                    data-unitlineref="@detail.UNITLINEREF"
                    data-itmunitaref="@(detail.ITMUNITAREF ?? 0)">

                    <td>@detail.ITEMNAME</td>
                    <td>@detail.LOGICALREF</td>
                    <td>@detail.ITEMREF</td>
                    <td>@detail.UNITLINEREF</td>
                    <td>@detail.UNITNAME</td>
                    
                    <td contenteditable="true" class="editable" data-field="BARCODE">@detail.BARCODE</td>
                    <td contenteditable="true" class="editable" data-field="PURCHASEPRICE">@detail.PURCHASEPRICE</td>
                    <td contenteditable="true" class="editable" data-field="SALEPRICE">@detail.SALEPRICE</td>
                   
                </tr>
            }
        </tbody>
    </table>
</div>

<button type="button" onclick="saveChanges()">Kaydet</button>

<script>
    function saveChanges() {
        var rows = document.querySelectorAll("#itemBody tr");
        var data = [];
        
        rows.forEach(row => {
            var obj = {
                ITEMREF: parseInt(row.dataset.itemref),
                ITMUNITAREF: Number(row.dataset.itmunitaref) || 0,
                    UNITLINEREF: parseInt(row.dataset.unitlineref),
                    BARCODE: row.querySelector('[data-field="BARCODE"]').innerText.trim(),
                    PURCHASEPRICE: parseFloat(row.querySelector('[data-field="PURCHASEPRICE"]').innerText) || 0,
                    SALEPRICE: parseFloat(row.querySelector('[data-field="SALEPRICE"]').innerText) || 0,
                   
            };
            data.push(obj);
        });

        fetch('/ItemDetails/UpdateItems', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(res => res.ok ? alert("Güncellendi") : alert("Hata"))
        .catch(err => alert("Hata: " + err));
    }
</script>

@* <!-- BİRİMLER (ITMUNITA) -->
<div class="card mb-3">
    <div class="card-header">
        <strong>Birimler</strong>
    </div>

    <div class="card-body p-0">
        <table class="table table-bordered table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th>Birim</th>
                    <th>Çarpan</th>
                    <th>Ana Birim</th>
                    <th style="width:120px;">İşlem</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var unit in Model.Units)
                {
                    <tr>
                        <td>@unit.UnitCode</td>
                        <td>@unit.ConvFactor</td>
                        <td>
                            @(unit.IsMainUnit ? "Evet" : "Hayır")
                        </td>
                        <td>
                            <a class="btn btn-sm btn-primary"
                               href="@Url.Action("UnitDetail", "Item",
                                     new {
                                         itemRef = Model.ItemRef,
                                         itmUnitARef = unit.ItmUnitARef
                                     })">
                                Detay
                            </a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- SEÇİLEN BİRİM DETAY -->
@if (Model.SelectedUnit != null)
{
    <div class="card mb-3">
        <div class="card-header">
            <strong>Birim Detayı</strong>
        </div>

        <div class="card-body">
            <div class="row mb-2">
                <div class="col-md-2"><strong>Birim</strong></div>
                <div class="col-md-4">@Model.SelectedUnit.UnitCode</div>

                <div class="col-md-2"><strong>Çarpan</strong></div>
                <div class="col-md-4">@Model.SelectedUnit.ConvFactor</div>
            </div>
        </div>
    </div>

    <!-- BARKODLAR -->
    <div class="card mb-3">
        <div class="card-header">
            <strong>Barkodlar</strong>
        </div>

        <div class="card-body">
            <table class="table table-sm table-bordered">
                <thead>
                    <tr>
                        <th>Barkod</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var bc in Model.SelectedUnit.Barcodes)
                    {
                        <tr>
                            <td>@bc.Barcode</td>
                        </tr>
                    }
                </tbody>
            </table>

            <form method="post" action="@Url.Action("AddBarcode", "Item")">
                <input type="hidden" name="ItmUnitARef" value="@Model.SelectedUnit.ItmUnitARef" />

                <div class="row">
                    <div class="col-md-4">
                        <input type="text"
                               name="Barcode"
                               class="form-control"
                               placeholder="Yeni barkod giriniz" />
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-success">Ekle</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- FİYATLAR -->
    <div class="card mb-3">
        <div class="card-header">
            <strong>Fiyatlar</strong>
        </div>

        <div class="card-body">
            <table class="table table-sm table-bordered">
                <thead>
                    <tr>
                        <th>Tip</th>
                        <th>Fiyat</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var prc in Model.SelectedUnit.Prices)
                    {
                        <tr>
                            <td>@(prc.PType == 1 ? "Satın Alma" : "Satış")</td>
                            <td>@prc.Price</td>
                        </tr>
                    }
                </tbody>
            </table>

            <form method="post" action="@Url.Action("AddPrice", "Item")">
                <input type="hidden" name="ItmUnitARef" value="@Model.SelectedUnit.ItmUnitARef" />

                <div class="row mb-2">
                    <div class="col-md-3">
                        <select name="PType" class="form-select">
                            <option value="1">Satın Alma</option>
                            <option value="2">Satış</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="text"
                               name="Price"
                               class="form-control"
                               placeholder="Fiyat" />
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-success">Ekle</button>
                    </div>
                </div>
            </form>
        </div>
    </div> 
} *@





