@model WebCrudApp.Models.Item.ItemViewModel
@{
}
<h3 style="margin-top:10px; margin-bottom:20px; ">Malzeme Verilerini Düzenleyin : </h3>

<!-- ÜRÜN ÜST BİLGİ -->
<div class="card mb-3">
    <div class="card-header">
        <strong>Ürün Bilgileri</strong>
    </div>
    <div class="card-body">
        <div class="row mb-2">
            <div class="col-md-1"><strong>Kod: </strong></div>
            <div class="col-md-3">@Model.CODE</div>

            <div class="col-md-1"><strong>Ad: </strong></div>
            <div class="col-md-3">@Model.NAME</div>

            <div class="col-md-1"><strong>UnitName: </strong></div>
            <div class="col-md-3">@Model.UNITNAME</div>
        </div>
    </div>
</div>

<div class="card mb-3">
    <table id="itemTable" class="table table-hover" border="1" style="border-collapse: collapse;">
        <thead>
            <tr>
                <th>ITEM NAME</th>
                <th>LOGICALREF</th>
                <th>ITEMREF</th> 
                <th>UNITLINEREF</th>
                <th>UNITNAME</th>
                <th>BARCODE</th>
                <th>PURCHASEPRICE</th>
                <th>SALEPRICE</th>
                <th>   </th>
            </tr>
        </thead>
        <tbody id="itemBody">
            @foreach (var detail in Model.UnitDetails)
            {
                <tr data-itemref="@detail.ITEMREF"
                    data-unitlineref="@detail.UNITLINEREF"
                    data-itmunitaref="@(detail.ITMUNITAREF ?? 0)">

                    <td>@detail.ITEMNAME</td>
                    <td>@detail.LOGICALREF</td>
                    <td>@detail.ITEMREF</td>
                    <td>@detail.UNITLINEREF</td>
                    <td>@detail.UNITNAME</td>
                    
                    <td contenteditable="true" class="editable" data-field="BARCODE">@detail.BARCODE</td>
                    <td contenteditable="true" class="editable" data-field="PURCHASEPRICE">@detail.PURCHASEPRICE</td>
                    <td contenteditable="true" class="editable" data-field="SALEPRICE">@detail.SALEPRICE</td>
                   
                </tr>
            }
        </tbody>
    </table>
</div>

<button type="button" onclick="saveChanges()">Kaydet</button>

<script src="~/lib/jquery/dist/jquery.min.js"></script>
<script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>

<script>
    function saveChanges() {
        var rows = document.querySelectorAll("#itemBody tr");
        var data = [];
        
        rows.forEach(row => {
            var obj = {
                ITEMREF: parseInt(row.dataset.itemref),
                ITMUNITAREF: Number(row.dataset.itmunitaref) || 0,
                    UNITLINEREF: parseInt(row.dataset.unitlineref),
                    BARCODE: row.querySelector('[data-field="BARCODE"]').innerText.trim(),
                    PURCHASEPRICE: parseFloat(row.querySelector('[data-field="PURCHASEPRICE"]').innerText) || 0,
                    SALEPRICE: parseFloat(row.querySelector('[data-field="SALEPRICE"]').innerText) || 0,
                   
            };
            data.push(obj);
        });

        fetch('/ItemDetails/UpdateItems', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(res => res.ok ? alert("Güncellendi") : alert("Hata"))
        .catch(err => alert("Hata: " + err));
    }
</script>
