

@model Library.Models.Item.ItemViewModel
@{
    ViewBag.Title = "Ürün Detayları";
}

<h3 class="mb-6 mt-4 text-lg font-semibold">
    Malzeme Verilerini Düzenleyin
</h3>

<!-- ÜRÜN ÜST BİLGİ -->
<div class="mb-4 rounded border border-gray-300 bg-white">
    <div class="border-b bg-gray-50 px-4 py-2 font-semibold">
        Ürün Bilgileri
    </div>
    <div class="flex flex-wrap gap-4 px-4 py-3 text-sm">
        <div class="w-3/12"><strong>Kod:</strong> @Model.CODE</div>
        <div class="w-4/12"><strong>Ad:</strong> @Model.NAME</div>
        <div class="w-3/12"><strong>Unit:</strong> @Model.UNITNAME</div>
    </div>
</div>

<!-- HEADER -->
<div class="hidden border border-gray-300 bg-gray-100 font-bold md:flex">
    <div class="w-3/12 p-2">ITEM NAME</div>
    <div class="w-1/12 p-2">LOGICALREF</div>
    <div class="w-1/12 p-2">ITEMREF</div>
    <div class="w-1/12 p-2">UNITLINEREF</div>
    <div class="w-2/12 p-2">UNITNAME</div>
    <div class="w-2/12 p-2">BARCODE</div>
    <div class="w-1/12 p-2">PURCHASE</div>
    <div class="w-1/12 p-2">SALE</div>
</div>

<!-- LIST -->
<div id="itemListContainer" class="border border-t-0 border-gray-300">

@foreach (var detail in Model.UnitDetails)
{
    <div class="list-row rowSelect m-2 flex cursor-pointer flex-wrap items-center border-t px-2 py-2 hover:bg-blue-50"
         data-itemref="@detail.ITEMREF"
         data-unitlineref="@detail.UNITLINEREF"
         data-itmunitaref="@(detail.ITMUNITAREF ?? 0)">

        <div class="w-full break-words p-2 md:w-3/12">
            @detail.ITEMNAME
        </div>

        <div class="w-full p-2 text-sm md:w-1/12">
            @detail.LOGICALREF
        </div>

        <div class="w-full p-2 text-sm md:w-1/12">
            @detail.ITEMREF
        </div>

        <div class="w-full p-2 text-sm md:w-1/12">
            @detail.UNITLINEREF
        </div>

        <div class="w-full p-2 md:w-2/12">
            @detail.UNITNAME
        </div>

        <div class="w-full p-2 md:w-2/12">
            <div contenteditable="true"
                 data-field="BARCODE"
                 class="rounded border border-gray-300 px-2 py-1 text-sm">
                 @(detail.BARCODE?.ToString() ?? "0")
            </div>
        </div>

        <div class="w-full p-2 md:w-1/12">
            <div contenteditable="true"
                 data-field="PURCHASEPRICE"
                 class="rounded border border-gray-300 px-2 py-1 text-right text-sm">
                @(detail.PURCHASEPRICE?.ToString() ?? "0")
            </div>
        </div>

        <div class="w-full p-2 md:w-1/12">
            <div contenteditable="true"
                 data-field="SALEPRICE"
                 class="rounded border border-gray-300 px-2 py-1 text-right text-sm">
                 @(detail.SALEPRICE?.ToString() ?? "0")
            </div>
        </div>

    </div>
}
</div>

<button onclick="saveChanges()"
        class="mt-4 rounded bg-blue-600 px-6 py-2 text-white hover:bg-blue-700">
    Kaydet
</button>


<script>
    function saveChanges() {
        var rows = document.querySelectorAll("#itemListContainer .list-row");
        var data = [];

        rows.forEach(row => {
            var obj = {
                ITEMREF: parseInt(row.dataset.itemref),
                ITMUNITAREF: Number(row.dataset.itmunitaref) || 0,
                UNITLINEREF: parseInt(row.dataset.unitlineref),
                BARCODE: row.querySelector('[data-field="BARCODE"]').innerText.trim(),
                PURCHASEPRICE: parseFloat(row.querySelector('[data-field="PURCHASEPRICE"]').innerText) || 0,
                SALEPRICE: parseFloat(row.querySelector('[data-field="SALEPRICE"]').innerText) || 0
            };
            data.push(obj);
        });

        fetch('/ItemDetails/UpdateItems', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(res => {
            if (res.ok) {
                alert("Güncellendi");
                window.location.href = "/Item/Index";
            } else {
                alert("Hata");
            }
        })
        .catch(err => alert("Hata: " + err));
    }

    // Row select çalışması
    $(document).on("click", ".rowSelect", function() {
        $(".rowSelect").removeClass("bg-blue-50 border-blue-600 ring-1 ring-blue-500");
        $(this).addClass("bg-blue-50 border-blue-600 ring-1 ring-blue-500");
    });
</script>
